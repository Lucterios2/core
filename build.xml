<project name="Lucterios2" default="all" basedir=".">
	<property name="test.instance" value="test"/>
	<property name="web.version" value="0.9.8"/>
	<property environment="env"/>
	<property name="standard.path" value="${basedir}/../lct-standard"/>
	
	<available file="/usr/local/bin/coverage2" property="python2.present"/>
	<available file="/usr/local/bin/coverage3" property="python3.present"/>

	<taskdef name="jslint"
       classname="com.googlecode.jslint4java.ant.JSLintTask"
       classpath="lucterios/web/jslint/jslint4java-2.0.5.jar" />	

	<target name="all">
		<antcall target="clear" />
		<antcall target="init" />
		<antcall target="pylint" />
		<antcall target="add_instance"/>
		<antcall target="i18n" />
		<antcall target="web" />
		<antcall target="package" />
		<antcall target="tests" />
		<antcall target="del_instance"/>
	</target>

	<target name="clear">
		<delete dir="dist"/>
		<delete dir="${test.instance}"/>		
		<delete file="manage_${test.instance}.py"/>
		<delete file="coverage2.xml"/>
		<delete file="coverage3.xml"/>
		<delete file="junit_py0.xml"/>
		<delete file="junit_py2.xml"/>
		<delete file="junit_py3.xml"/>
		<delete file="pylint.txt"/>
		<delete file="MANIFEST"/>
		<delete>
		    <fileset dir="." includes="**/*.pyc"/>
		</delete>		
		<delete dir="CORE/__pycache__"/>
		<delete dir="framework/__pycache__"/>
		<delete dir="install/__pycache__"/>
		<delete dir="standard/__pycache__"/>
	</target>

	<target name="init">
		<exec executable="git" outputproperty="build.hnum" failifexecutionfails="false" errorproperty="">
		        <arg value="describe"/>
		        <arg value="--tags"/>
		        <arg value="--always"/>
		        <arg value="HEAD"/>
		</exec>		
		<exec executable="python" outputproperty="build.num" failifexecutionfails="false" errorproperty="">
	        <arg value="-c"/>
			<arg value="print(int('${build.hnum}', 16))"/>
		</exec>
		<tstamp>
			<format property="build.time" pattern="yyMMdd" unit="hour" />
		</tstamp> 		
		<property name="projet.version.build" value="${build.time}${build.num}"/>
		<echo message="${projet.version.build}" file="lucterios/CORE/build" append="false" />		
		<echo message='&lt;testsuite errors="0" failures="0" name="null test" skips="0" tests="0" time="0"&gt;&lt;/testsuite&gt;'  file="junit_py0.xml" append="false" />
	</target>

	<target name="pylint">
		<exec executable="pylint">
			<arg line="--rcfile=./rcfile"/>
			<arg line="--msg-template='{path}:{line}: [{msg_id}({symbol}), {obj}] {msg}'"/>
			<arg line="--reports=y"/>
			<arg line="lucterios"/>
			<redirector output="pylint.txt"/>
		</exec>
		<exec executable="sed">
			<arg line="/Report/,$d"/>
			<arg line="pylint.txt" />
		</exec>
		<exec executable="grep">
			<arg line="'Your code has been rated'" />
			<arg line="pylint.txt" />
		</exec>
	</target>	

	<target name="i18n_comp">
		<echo message="-- extract ${sub_path} --"/>
		<exec executable="python" dir="./${sub_path}">
			<env key="PYTHONPATH" value="${standard.path}:${env.PYTHONPATH}"/>
			<arg value="${basedir}/manage_${test.instance}.py"/>
			<arg value="makemessages"/>
		    <arg value="-l"/>
		    <arg value="fr"/>
		    <arg value="-l"/>
		    <arg value="en"/>
		</exec>	

		<echo message="-- compile ${sub_path} --"/>
		<exec executable="python" dir="./${sub_path}">
			<env key="PYTHONPATH" value="${standard.path}:${env.PYTHONPATH}"/>
			<arg value="${basedir}/manage_${test.instance}.py"/>
			<arg value="compilemessages"/>
		</exec>	
	</target>
	
	<target name="i18n">
		<antcall target="i18n_comp"><param name="sub_path" value="lucterios/CORE"/></antcall>			
		<antcall target="i18n_comp"><param name="sub_path" value="lucterios/framework"/></antcall>			
		<antcall target="i18n_comp"><param name="sub_path" value="lucterios/install"/></antcall>
	</target>	

	<target name="add_instance">
		<exec executable="python3">
			<env key="PYTHONPATH" value="${basedir}:${standard.path}:${env.PYTHONPATH}"/>
			<arg value="lucterios/install/lucterios_admin.py"/>
			<arg value="add"/>
			<arg value="--name=${test.instance}"/>
			<arg value="--module=lucterios.dummy"/>			
			<arg value="--instance_path=${basedir}"/>
		</exec>	
	</target>	

	<target name="del_instance">
		<exec executable="python3">
			<env key="PYTHONPATH" value="${basedir}:${standard.path}:${env.PYTHONPATH}"/>
			<arg value="lucterios/install/lucterios_admin.py"/>
			<arg value="delete"/>
			<arg value="--name=${test.instance}"/>
			<arg value="--instance_path=${basedir}"/>
		</exec>	
	</target>	

	<target name="test">
		<echo message="-- test with ${testversion} --"/>
		<delete file=".converage"/>
		<delete file="converage.xml"/>
		<delete file="${testversion}.xml"/>
		<exec executable="${testversion}">
			<arg value="erase"/> 
		</exec>	
		<exec executable="${testversion}">
			<env key="PYTHONPATH" value="${standard.path}:${env.PYTHONPATH}"/>
			<arg value="run"/>
			<arg value="--branch"/>
			<arg value="--source=lucterios"/>
			<arg value="--omit=lucterios/install/lucterios_gui.py"/>
			<arg value="./manage_${test.instance}.py"/>
			<arg value="test"/>
			<arg value="CORE"/>
			<arg value="dummy"/>
		</exec>	
		<exec executable="${testversion}">
			<env key="PYTHONPATH" value="${basedir}:${standard.path}:${env.PYTHONPATH}"/>
			<arg value="run"/>
			<arg value="--append"/>
			<arg value="--branch"/>
			<arg value="--source=lucterios"/>
			<arg value="--omit=lucterios/install/lucterios_gui.py"/>
			<arg value="lucterios/install/admin_test.py"/>
		</exec>
		<exec executable="${testversion}">
			<arg value="report"/>
		</exec>	
		<exec executable="${testversion}">
			<arg value="xml"/>
		</exec>
		<move file="coverage.xml" tofile="${testversion}.xml"/>
		<replace file="${testversion}.xml" token='filename="lucterios' value='filename="${basedir}/lucterios' />		
		<replaceregexp file="${testversion}.xml" match="&lt;source&gt;.*&lt;/source&gt;" replace="&lt;source&gt;/&lt;/source&gt;" byline="true" />
	</target>

	<target name="test_py2" if="python2.present">
		<echo message='&lt;testsuite errors="0" failures="0" name="null test" skips="0" tests="0" time="0"&gt;&lt;/testsuite&gt;'  file="junit_py2.xml" append="false" />
		<antcall target="test"><param name="testversion" value="coverage2"/></antcall>
		<replace file="junit_py2.xml" token="lucterios." value="lucterios-py2."/>		
		<delete file="results.xml"/>
	</target>

	<target name="test_py3" if="python3.present">
		<echo message='&lt;testsuite errors="0" failures="0" name="null test" skips="0" tests="0" time="0"&gt;&lt;/testsuite&gt;'  file="junit_py3.xml" append="false" />
		<antcall target="test"><param name="testversion" value="coverage3"/></antcall>
		<replace file="junit_py3.xml" token="lucterios." value="lucterios-py3."/>		
		<replace file="results.xml" token="__main__." value="lucterios-py3.TestAdmin."/>
		<move file="results.xml" tofile="junit_admin_py3.xml"/>
	</target>

	<target name="tests">
		<antcall target="test_py2"/>
		<antcall target="test_py3"/>
	</target>

	<target name="jslint">
		<jslint encoding="UTF-8" options="white,browser,plusplus,newcap,sloppy,nomen,evil,indent=4" haltOnFailure='false'>
			<predef>jQuery, setTimeout, history, window, document, btoa, atob, FileReader, Blob</predef>
			<formatter type="xml" destfile="jslint_results.xml"/> 
			<fileset dir="lucterios/web/" includes="js/*.js"/>
		</jslint>
	</target>

	<target name="web" depends="init">
		<copy file="lucterios/web/deployed/conf_template.js" tofile="lucterios/web/conf/conf.js"/>
		<replace file="lucterios/web/conf/conf.js" token="G_Version = 'X.X.X.X';" value="G_Version = '${web.version}.${projet.version.build}';"/>
		<antcall target="jslint"/>
	</target>

	<target name="package">
		<delete file="MANIFEST"/>
		<exec executable="python3">
			<arg value="setup.py"/>
			<arg value="sdist"/>
		</exec>
		<delete dir="lucterios.egg-info"/>
	</target>
	
</project>	
